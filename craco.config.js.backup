const path = require("path");

module.exports = {
  style: {
    postcss: {
      plugins: [require("tailwindcss"), require("autoprefixer")],
      loaderOptions: (postcssLoaderOptions) => {
        postcssLoaderOptions.postcssOptions.plugins = [
          require("tailwindcss"),
          require("autoprefixer"),
        ];
        return postcssLoaderOptions;
      },
    },
  },
  webpack: {
    alias: {
      "@": path.resolve(__dirname, "src"),
    },
    configure: (webpackConfig) => {
      // Adicionar fallbacks para resolver erros de dependências
      webpackConfig.resolve = {
        ...webpackConfig.resolve,
        fallback: {
          ...webpackConfig.resolve.fallback,
          buffer: false,
          crypto: false,
          stream: false,
          util: false,
          assert: false,
          http: false,
          https: false,
          os: false,
          url: false,
          fs: false,
          path: false,
        },
      };

      // Adicionar define plugin para variáveis globais
      const webpack = require("webpack");
      webpackConfig.plugins.push(
        new webpack.DefinePlugin({
          global: "window",
          "process.env.NODE_ENV": JSON.stringify(
            process.env.NODE_ENV || "development"
          ),
        })
      );

      return webpackConfig;
    },
  },
  devServer: (devServerConfig, { env, paths }) => {
    // Configuração compatível com diferentes versões do webpack-dev-server
    return {
      ...devServerConfig,
      port: 3001,
      hot: true,
      liveReload: true,
      historyApiFallback: true,
      client: {
        overlay: {
          errors: true,
          warnings: false,
        },
        progress: true,
      },
      // Usar setupMiddlewares se disponível, senão usar onAfterSetupMiddleware
      ...(devServerConfig.setupMiddlewares
        ? {
            setupMiddlewares: (middlewares, devServer) => {
              return middlewares;
            },
          }
        : {
            onAfterSetupMiddleware: (devServer) => {
              // Compatibilidade com versões antigas
            },
          }),
    };
  },
};
